<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å®æ—¶æ—¥å¿—è®°å½•æµ‹è¯•</title>
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .container {
            background: white;
            border-radius: 12px;
            padding: 24px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-number {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 8px;
        }
        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }
        .button-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 12px;
            margin-bottom: 24px;
        }
        .test-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
        }
        .test-btn:hover {
            background: #45a049;
        }
        .test-btn.danger {
            background: #f44336;
        }
        .test-btn.danger:hover {
            background: #da190b;
        }
        .test-btn.info {
            background: #2196F3;
        }
        .test-btn.info:hover {
            background: #0b7dda;
        }
        .log-area {
            background: #1e1e1e;
            color: #00ff00;
            padding: 16px;
            border-radius: 6px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .status {
            padding: 8px 12px;
            border-radius: 4px;
            margin: 8px 0;
            font-weight: bold;
        }
        .status.success { background: #d4edda; color: #155724; }
        .status.error { background: #f8d7da; color: #721c24; }
        .status.info { background: #d1ecf1; color: #0c5460; }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ”„ å®æ—¶æ—¥å¿—è®°å½•æµ‹è¯•ç³»ç»Ÿ</h1>
        <p>æµ‹è¯•ç”¨æˆ·è¡Œä¸ºè®°å½•å’Œç»Ÿè®¡æ•°æ®çš„å®æ—¶æ›´æ–°åŠŸèƒ½</p>
        
        <div id="status"></div>
        
        <h2>ğŸ“Š å½“å‰ç»Ÿè®¡æ•°æ®</h2>
        <div class="stats-grid" id="statsGrid">
            <div class="stat-card">
                <div class="stat-number" id="newUsers">-</div>
                <div class="stat-label">ä»Šæ—¥æ–°ç”¨æˆ·</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="downloads">-</div>
                <div class="stat-label">ä»Šæ—¥ä¸‹è½½</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="apiCalls">-</div>
                <div class="stat-label">APIè°ƒç”¨</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="removeBg">-</div>
                <div class="stat-label">æŠ å›¾æ¬¡æ•°</div>
            </div>
        </div>
        
        <h2>ğŸ® æ¨¡æ‹Ÿç”¨æˆ·è¡Œä¸º</h2>
        <div class="button-grid">
            <button class="test-btn" onclick="simulateUserRegistration()">ğŸ‘¤ æ¨¡æ‹Ÿç”¨æˆ·æ³¨å†Œ</button>
            <button class="test-btn" onclick="simulateDownload()">ğŸ“¥ æ¨¡æ‹Ÿä¸‹è½½è¡Œä¸º</button>
            <button class="test-btn" onclick="simulateRemoveBg()">ğŸ–¼ï¸ æ¨¡æ‹ŸæŠ å›¾æ“ä½œ</button>
            <button class="test-btn info" onclick="refreshStats()">ğŸ”„ åˆ·æ–°ç»Ÿè®¡æ•°æ®</button>
            <button class="test-btn danger" onclick="clearData()">ğŸ—‘ï¸ æ¸…ç©ºæ•°æ®</button>
            <button class="test-btn info" onclick="toggleAutoRefresh()">â° è‡ªåŠ¨åˆ·æ–°</button>
        </div>
        
        <h2>ğŸ“ æ“ä½œæ—¥å¿—</h2>
        <div class="log-area" id="logArea"></div>
    </div>

    <script>
        let autoRefreshInterval = null;
        
        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logArea = document.getElementById('logArea');
            const prefix = type === 'error' ? 'âŒ' : type === 'success' ? 'âœ…' : 'â„¹ï¸';
            logArea.textContent += `[${timestamp}] ${prefix} ${message}\n`;
            logArea.scrollTop = logArea.scrollHeight;
        }
        
        function showStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.innerHTML = `<div class="status ${type}">${message}</div>`;
        }
        
        async function refreshStats() {
            try {
                log('æ­£åœ¨è·å–ç»Ÿè®¡æ•°æ®...');
                const response = await fetch('/api/admin/today-stats');
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const result = await response.json();
                
                if (result.success) {
                    const data = result.data;
                    document.getElementById('newUsers').textContent = data.todayNewUsers || 0;
                    document.getElementById('downloads').textContent = data.todayDownloads || 0;
                    document.getElementById('apiCalls').textContent = data.todayApiCalls || 0;
                    document.getElementById('removeBg').textContent = data.todayRemoveBg || 0;
                    
                    log(`ç»Ÿè®¡æ•°æ®æ›´æ–°æˆåŠŸ: æ–°ç”¨æˆ·${data.todayNewUsers}, ä¸‹è½½${data.todayDownloads}, API${data.todayApiCalls}, æŠ å›¾${data.todayRemoveBg}`, 'success');
                    showStatus('ç»Ÿè®¡æ•°æ®å·²æ›´æ–°', 'success');
                } else {
                    throw new Error(result.error || 'è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥');
                }
            } catch (error) {
                log(`è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥: ${error.message}`, 'error');
                showStatus(`è·å–ç»Ÿè®¡æ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function simulateUserRegistration() {
            try {
                log('æ­£åœ¨æ¨¡æ‹Ÿç”¨æˆ·æ³¨å†Œ...');
                const response = await fetch('/api/test/simulate-action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'user_registration',
                        user_id: `test_user_${Date.now()}`,
                        details: { source: 'test_page' }
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    log('ç”¨æˆ·æ³¨å†Œæ¨¡æ‹ŸæˆåŠŸ', 'success');
                    setTimeout(refreshStats, 1000);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                log(`æ¨¡æ‹Ÿç”¨æˆ·æ³¨å†Œå¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function simulateDownload() {
            try {
                log('æ­£åœ¨æ¨¡æ‹Ÿä¸‹è½½è¡Œä¸º...');
                const response = await fetch('/api/test/simulate-action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'download',
                        user_id: `test_user_${Date.now()}`,
                        details: { file_type: 'business_card' }
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    log('ä¸‹è½½è¡Œä¸ºæ¨¡æ‹ŸæˆåŠŸ', 'success');
                    setTimeout(refreshStats, 1000);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                log(`æ¨¡æ‹Ÿä¸‹è½½å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function simulateRemoveBg() {
            try {
                log('æ­£åœ¨æ¨¡æ‹ŸæŠ å›¾æ“ä½œ...');
                const response = await fetch('/api/test/simulate-action', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'remove_background',
                        user_id: `test_user_${Date.now()}`,
                        details: { image_size: '1024x768' }
                    })
                });
                
                const result = await response.json();
                if (result.success) {
                    log('æŠ å›¾æ“ä½œæ¨¡æ‹ŸæˆåŠŸ', 'success');
                    setTimeout(refreshStats, 1000);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                log(`æ¨¡æ‹ŸæŠ å›¾å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        async function clearData() {
            if (!confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æµ‹è¯•æ•°æ®å—ï¼Ÿ')) return;
            
            try {
                log('æ­£åœ¨æ¸…ç©ºæ•°æ®...');
                const response = await fetch('/api/test/clear-data', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ confirm: true })
                });
                
                const result = await response.json();
                if (result.success) {
                    log('æ•°æ®æ¸…ç©ºæˆåŠŸ', 'success');
                    setTimeout(refreshStats, 1000);
                } else {
                    throw new Error(result.error);
                }
            } catch (error) {
                log(`æ¸…ç©ºæ•°æ®å¤±è´¥: ${error.message}`, 'error');
            }
        }
        
        function toggleAutoRefresh() {
            if (autoRefreshInterval) {
                clearInterval(autoRefreshInterval);
                autoRefreshInterval = null;
                log('è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢');
                showStatus('è‡ªåŠ¨åˆ·æ–°å·²åœæ­¢', 'info');
            } else {
                autoRefreshInterval = setInterval(refreshStats, 10000);
                log('è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯ (10ç§’é—´éš”)');
                showStatus('è‡ªåŠ¨åˆ·æ–°å·²å¼€å¯ (10ç§’é—´éš”)', 'info');
            }
        }
        
        // é¡µé¢åŠ è½½æ—¶åˆå§‹åŒ–
        window.addEventListener('load', function() {
            log('å®æ—¶æ—¥å¿—è®°å½•æµ‹è¯•ç³»ç»Ÿå·²å¯åŠ¨');
            refreshStats();
        });
    </script>
</body>
</html>