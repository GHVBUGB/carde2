<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>零压缩导出测试</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background: #f5f5f5;
        }
        
        .test-card {
            width: 350px;
            height: 500px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 16px;
            position: relative;
            margin: 20px auto;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            overflow: hidden;
        }
        
        .test-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="20" cy="20" r="2" fill="rgba(255,255,255,0.1)"/><circle cx="80" cy="40" r="1.5" fill="rgba(255,255,255,0.1)"/><circle cx="40" cy="80" r="1" fill="rgba(255,255,255,0.1)"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }
        
        .avatar {
            position: absolute;
            top: 50px;
            left: 50%;
            transform: translateX(-50%);
            width: 80px;
            height: 80px;
            border-radius: 50%;
            background: #fff;
            border: 4px solid #fff;
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: #667eea;
        }
        
        .name {
            position: absolute;
            top: 150px;
            left: 50%;
            transform: translateX(-50%);
            color: white;
            font-size: 18px;
            font-weight: bold;
            text-align: center;
        }
        
        .title {
            position: absolute;
            top: 180px;
            left: 50%;
            transform: translateX(-50%);
            color: rgba(255,255,255,0.9);
            font-size: 14px;
            text-align: center;
        }
        
        .stats {
            position: absolute;
            top: 220px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 30px;
        }
        
        .stat-item {
            text-align: center;
            color: white;
        }
        
        .stat-number {
            font-size: 24px;
            font-weight: bold;
        }
        
        .stat-label {
            font-size: 10px;
            opacity: 0.8;
        }
        
        .features {
            position: absolute;
            bottom: 80px;
            left: 20px;
            right: 20px;
            display: flex;
            justify-content: space-around;
        }
        
        .feature {
            text-align: center;
            color: white;
            font-size: 12px;
        }
        
        .phone {
            position: absolute;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(255,255,255,0.2);
            padding: 8px 16px;
            border-radius: 20px;
            color: white;
            font-size: 14px;
        }
        
        .controls {
            text-align: center;
            margin: 20px;
        }
        
        button {
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 5px;
            font-size: 16px;
        }
        
        button:hover {
            opacity: 0.9;
        }
        
        button:disabled {
            background: #ccc !important;
            cursor: not-allowed;
        }
        
        .svg-btn { background: #8b5cf6; }
        .zero-png-btn { background: #dc2626; }
        .zero-jpg-btn { background: #ea580c; }
        .svg-png-btn { background: #6366f1; }
    </style>
</head>
<body>
    <h1>零压缩导出功能测试</h1>
    <p>测试修复挤压问题的零压缩导出方法</p>
    
    <div class="controls">
        <button onclick="testSVGExport()" class="svg-btn">SVG (推荐)</button>
        <button onclick="testZeroCompressionExport('png')" class="zero-png-btn">零压缩PNG</button>
        <button onclick="testZeroCompressionExport('jpg')" class="zero-jpg-btn">零压缩JPG</button>
        <button onclick="testSVGToPNGExport()" class="svg-png-btn">SVG→PNG</button>
    </div>
    
    <div class="test-card" id="testCard">
        <div class="avatar">👤</div>
        <div class="name">AHMED AL-FAWAZ</div>
        <div class="title">SENIOR LANGUAGE COACH</div>
        <div class="stats">
            <div class="stat-item">
                <div class="stat-number">0</div>
                <div class="stat-label">STUDENTS<br>SERVED</div>
            </div>
            <div class="stat-item">
                <div class="stat-number">0%</div>
                <div class="stat-label">POSITIVE<br>RATING</div>
            </div>
        </div>
        <div class="features">
            <div class="feature">Teacher<br>Selection</div>
            <div class="feature">Progress<br>Feedback</div>
            <div class="feature">Study<br>Plan</div>
            <div class="feature">Learning<br>Resources</div>
        </div>
        <div class="phone">电话: 050-XXXX-XXAB</div>
    </div>
    
    <script>
        // SVG导出测试
        function testSVGExport() {
            console.log('=== SVG导出测试开始 ===');
            
            const svgContent = generateTestSVG();
            const svgBlob = new Blob([svgContent], { type: 'image/svg+xml' });
            saveAs(svgBlob, 'test-card.svg');
            alert('SVG导出成功！');
        }
        
        // 零压缩导出测试
        async function testZeroCompressionExport(format) {
            console.log('=== 零压缩导出测试开始 ===');
            
            const originalCard = document.getElementById('testCard');
            const rect = originalCard.getBoundingClientRect();
            console.log('原始元素尺寸:', rect.width, 'x', rect.height);
            
            const clonedCard = originalCard.cloneNode(true);
            
            // 设置克隆卡片的样式 - 保持原始比例
            clonedCard.style.position = 'absolute';
            clonedCard.style.left = '-9999px';
            clonedCard.style.top = '0';
            clonedCard.style.width = `${rect.width}px`;
            clonedCard.style.height = `${rect.height}px`;
            clonedCard.style.transform = 'none !important';
            clonedCard.style.zoom = '1 !important';
            clonedCard.style.backgroundSize = 'cover';
            clonedCard.style.backgroundPosition = 'center';
            clonedCard.style.backgroundRepeat = 'no-repeat';
            clonedCard.style.borderRadius = '16px';
            clonedCard.style.overflow = 'hidden';
            clonedCard.style.boxShadow = '0 25px 50px -12px rgba(0, 0, 0, 0.25)';
            
            // 移除所有子元素的变换，但保持位置
            const allElements = clonedCard.querySelectorAll('*');
            allElements.forEach((el) => {
                if (el.style.transform && el.style.transform !== 'none') {
                    el.style.transform = 'none !important';
                }
                el.style.zoom = '1 !important';
                el.style.scale = 'none !important';
            });
            
            document.body.appendChild(clonedCard);
            await new Promise(resolve => setTimeout(resolve, 500));
            
            const canvas = await html2canvas(clonedCard, {
                backgroundColor: null,
                useCORS: true,
                allowTaint: true,
                scale: 3, // 固定3倍分辨率
                width: rect.width,
                height: rect.height,
                logging: true,
                foreignObjectRendering: false,
                removeContainer: false,
                imageTimeout: 20000
            });
            
            document.body.removeChild(clonedCard);
            
            console.log('Canvas尺寸:', canvas.width, 'x', canvas.height);
            console.log('原始比例:', rect.width / rect.height);
            console.log('Canvas比例:', canvas.width / canvas.height);
            
            // 验证宽高比
            const originalRatio = rect.width / rect.height;
            const canvasRatio = canvas.width / canvas.height;
            const ratioDiff = Math.abs(originalRatio - canvasRatio);
            
            if (ratioDiff > 0.01) {
                console.warn('宽高比不匹配! 原始:', originalRatio, 'Canvas:', canvasRatio);
            } else {
                console.log('宽高比匹配! 比例:', originalRatio);
            }
            
            // 零压缩导出
            canvas.toBlob((blob) => {
                if (blob) {
                    console.log(`${format.toUpperCase()} Blob大小:`, blob.size, 'bytes');
                    saveAs(blob, `test-card-零压缩.${format}`);
                    alert(`零压缩${format.toUpperCase()}导出成功！`);
                } else {
                    alert(`生成${format.toUpperCase()}文件失败`);
                }
            }, format === 'jpg' ? 'image/jpeg' : 'image/png', 1.0);
        }
        
        // SVG转PNG导出测试
        function testSVGToPNGExport() {
            console.log('=== SVG转PNG导出测试开始 ===');
            
            const svgContent = generateTestSVG();
            const img = new Image();
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            const scale = 2;
            canvas.width = 350 * scale;
            canvas.height = 500 * scale;
            canvas.style.width = '350px';
            canvas.style.height = '500px';
            
            img.onload = () => {
                ctx.scale(scale, scale);
                ctx.drawImage(img, 0, 0, 350, 500);
                
                canvas.toBlob((blob) => {
                    if (blob) {
                        saveAs(blob, 'test-card-svg-png.png');
                        alert('SVG转PNG导出成功！');
                    }
                }, 'image/png', 1.0);
            };
            
            const svgBlob = new Blob([svgContent], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(svgBlob);
            img.src = url;
        }
        
        // 生成测试SVG
        function generateTestSVG() {
            return `
<svg width="700" height="1000" viewBox="0 0 700 1000" xmlns="http://www.w3.org/2000/svg">
  <defs>
    <linearGradient id="backgroundGradient" x1="0%" y1="0%" x2="100%" y2="100%">
      <stop offset="0%" style="stop-color:#667eea;stop-opacity:1" />
      <stop offset="100%" style="stop-color:#764ba2;stop-opacity:1" />
    </linearGradient>
    <filter id="cardShadow" x="-50%" y="-50%" width="200%" height="200%">
      <feDropShadow dx="0" dy="25" stdDeviation="25" flood-color="rgba(0,0,0,0.25)"/>
    </filter>
    <filter id="textShadow" x="-20%" y="-20%" width="140%" height="140%">
      <feDropShadow dx="0" dy="1" stdDeviation="1" flood-color="rgba(0,0,0,0.3)"/>
    </filter>
  </defs>
  
  <rect width="700" height="1000" fill="url(#backgroundGradient)" rx="32" ry="32" filter="url(#cardShadow)"/>
  
  <circle cx="350" cy="200" r="80" fill="#fff" stroke="#fff" stroke-width="8"/>
  <text x="350" y="210" font-family="Arial" font-size="32" fill="#667eea" text-anchor="middle">👤</text>
  
  <text x="350" y="400" font-family="Arial" font-size="36" font-weight="bold" fill="white" text-anchor="middle" filter="url(#textShadow)">AHMED AL-FAWAZ</text>
  <text x="350" y="440" font-family="Arial" font-size="28" fill="rgba(255,255,255,0.9)" text-anchor="middle" filter="url(#textShadow)">SENIOR LANGUAGE COACH</text>
  
  <g transform="translate(200, 500)">
    <text x="0" y="0" font-family="Arial" font-size="48" font-weight="bold" fill="white" text-anchor="middle" filter="url(#textShadow)">0</text>
    <text x="0" y="30" font-family="Arial" font-size="16" fill="white" text-anchor="middle" filter="url(#textShadow)">STUDENTS</text>
    <text x="0" y="50" font-family="Arial" font-size="16" fill="white" text-anchor="middle" filter="url(#textShadow)">SERVED</text>
  </g>
  
  <g transform="translate(500, 500)">
    <text x="0" y="0" font-family="Arial" font-size="48" font-weight="bold" fill="white" text-anchor="middle" filter="url(#textShadow)">0%</text>
    <text x="0" y="30" font-family="Arial" font-size="16" fill="white" text-anchor="middle" filter="url(#textShadow)">POSITIVE</text>
    <text x="0" y="50" font-family="Arial" font-size="16" fill="white" text-anchor="middle" filter="url(#textShadow)">RATING</text>
  </g>
  
  <g transform="translate(100, 700)">
    <text x="0" y="0" font-family="Arial" font-size="24" fill="white" text-anchor="middle" filter="url(#textShadow)">Teacher</text>
    <text x="0" y="20" font-family="Arial" font-size="24" fill="white" text-anchor="middle" filter="url(#textShadow)">Selection</text>
  </g>
  
  <g transform="translate(250, 700)">
    <text x="0" y="0" font-family="Arial" font-size="24" fill="white" text-anchor="middle" filter="url(#textShadow)">Progress</text>
    <text x="0" y="20" font-family="Arial" font-size="24" fill="white" text-anchor="middle" filter="url(#textShadow)">Feedback</text>
  </g>
  
  <g transform="translate(400, 700)">
    <text x="0" y="0" font-family="Arial" font-size="24" fill="white" text-anchor="middle" filter="url(#textShadow)">Study</text>
    <text x="0" y="20" font-family="Arial" font-size="24" fill="white" text-anchor="middle" filter="url(#textShadow)">Plan</text>
  </g>
  
  <g transform="translate(550, 700)">
    <text x="0" y="0" font-family="Arial" font-size="24" fill="white" text-anchor="middle" filter="url(#textShadow)">Learning</text>
    <text x="0" y="20" font-family="Arial" font-size="24" fill="white" text-anchor="middle" filter="url(#textShadow)">Resources</text>
  </g>
  
  <rect x="200" y="850" width="300" height="60" rx="30" ry="30" fill="rgba(255,255,255,0.2)"/>
  <text x="350" y="890" font-family="Arial" font-size="28" font-weight="bold" fill="white" text-anchor="middle" filter="url(#textShadow)">电话: 050-XXXX-XXAB</text>
</svg>
            `.trim();
        }
    </script>
</body>
</html>





