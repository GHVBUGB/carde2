我将为您编写完整的项目文档。以下是所有相关文档：

# 项目需求文档集合

## 1. 产品需求文档 (PRD)

### 1.1 项目概述
**项目名称：** 51Talk员工数字名片制作平台

**项目背景：** 为51Talk内部员工提供统一的数字名片制作工具，提升品牌形象和业务展示效果。

**目标用户：** 51Talk阿里邮箱用户（内部员工）

### 1.2 功能需求

#### 1.2.1 用户端功能
1. **用户认证**
   - 阿里邮箱注册/登录
   - 邮箱验证码验证
 
2. **名片编辑功能**
   - 头像上传及AI抠图
   - 个人信息编辑
   - 模块拖拽布局（管理员解锁后）
   - 实时预览
 
3. **信息管理**
   - 姓名编辑
   - 头衔选择（4个固定选项）
   - 业绩数据录入
   - 联系方式管理
 
4. **导出功能**
   - 名片图片导出
   - 多格式支持

#### 1.2.2 管理端功能
1. **数据统计面板**
   - 用户使用统计
   - API调用统计
   - 下载数据统计
 
2. **布局管理**
   - 模块位置锁定/解锁
   - 默认布局设置
 
3. **用户管理**
   - 用户列表查看
   - 行为记录查询

### 1.3 技术需求
- Remove.bg API集成
- Supabase数据库
- 响应式设计
- 拖拽交互

---

## 2. 技术架构文档

### 2.1 系统架构图

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   前端应用      │    │   后端API      │    │   数据库层      │
│                 │    │                 │    │                 │
│ - React/Vue     │◄──►│ - Node.js      │◄──►│ - Supabase     │
│ - 拖拽组件      │    │ - Express      │    │ - PostgreSQL   │
│ - 图片处理      │    │ - JWT认证      │    │                 │
└─────────────────┘    └─────────────────┘    └─────────────────┘
        │                        │
        │                        │
        ▼                        ▼
┌─────────────────┐    ┌─────────────────┐
│   第三方服务    │    │   邮件服务      │
│                 │    │                 │
│ - Remove.bg API │    │ - 阿里邮箱API   │
│ - 图片CDN       │    │ - 验证码服务    │
└─────────────────┘    └─────────────────┘
```

### 2.2 数据库设计

#### 用户表 (users)
```sql
CREATE TABLE users (
  id SERIAL PRIMARY KEY,
  email VARCHAR(255) UNIQUE NOT NULL,
  name VARCHAR(100),
  avatar_url TEXT,
  title ENUM('首席成长伙伴', '金牌成长顾问', '五星服务官', '学习领航官'),
  students_served INTEGER DEFAULT 0,
  rating DECIMAL(3,2) DEFAULT 0,
  phone VARCHAR(20),
  created_at TIMESTAMP DEFAULT NOW(),
  updated_at TIMESTAMP DEFAULT NOW()
);
```

#### 布局配置表 (layout_config)
```sql
CREATE TABLE layout_config (
  id SERIAL PRIMARY KEY,
  module_name VARCHAR(50) NOT NULL,
  x_position INTEGER DEFAULT 0,
  y_position INTEGER DEFAULT 0,
  z_index INTEGER DEFAULT 0,
  is_locked BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);
```

#### 使用统计表 (usage_stats)
```sql
CREATE TABLE usage_stats (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id),
  action_type VARCHAR(50), -- 'api_call', 'download', 'login'
  details JSON,
  created_at TIMESTAMP DEFAULT NOW()
);
```

---

## 3. 前端开发文档

### 3.1 技术栈
- **框架：** React 18 + TypeScript
- **状态管理：** Redux Toolkit
- **UI组件：** Ant Design
- **拖拽：** react-dnd
- **图片处理：** fabric.js
- **HTTP客户端：** axios

### 3.2 项目结构
```
src/
├── components/          # 通用组件
│   ├── DragModule/     # 拖拽模块组件
│   ├── NameCardEditor/ # 名片编辑器
│   └── ImageUpload/    # 图片上传组件
├── pages/              # 页面组件
│   ├── Login/          # 登录页
│   ├── Dashboard/      # 用户面板
│   └── Admin/          # 管理面板
├── hooks/              # 自定义Hook
├── services/           # API服务
├── store/              # Redux store
├── types/              # TypeScript类型
└── utils/              # 工具函数
```

### 3.3 核心组件设计

#### 3.3.1 拖拽模块组件
```typescript
interface DragModuleProps {
  id: string;
  position: { x: number; y: number; z: number };
  isLocked: boolean;
  children: React.ReactNode;
  onPositionChange: (id: string, position: Position) => void;
}

const DragModule: React.FC<DragModuleProps> = ({
  id,
  position,
  isLocked,
  children,
  onPositionChange
}) => {
  // 拖拽逻辑实现
};
```

#### 3.3.2 名片编辑器
```typescript
interface NameCardEditorProps {
  userInfo: UserInfo;
  layoutConfig: LayoutConfig[];
  onSave: (data: UserInfo) => void;
  onExport: () => void;
}

const NameCardEditor: React.FC<NameCardEditorProps> = ({
  userInfo,
  layoutConfig,
  onSave,
  onExport
}) => {
  // 编辑器逻辑实现
};
```

### 3.4 状态管理
```typescript
interface RootState {
  auth: AuthState;
  user: UserState;
  layout: LayoutState;
  stats: StatsState;
}

// 用户状态
interface UserState {
  userInfo: UserInfo;
  loading: boolean;
  error: string | null;
}

// 布局状态
interface LayoutState {
  modules: LayoutModule[];
  isLocked: boolean;
  dragMode: boolean;
}
```

---

## 4. 后端开发文档

### 4.1 技术栈
- **运行时：** Node.js 18+
- **框架：** Express.js
- **数据库：** Supabase (PostgreSQL)
- **认证：** JWT
- **图片处理：** Remove.bg API
- **邮件服务：** 阿里邮箱API

### 4.2 项目结构
```
src/
├── controllers/        # 控制器
│   ├── auth.js        # 认证控制器
│   ├── user.js        # 用户控制器
│   ├── layout.js      # 布局控制器
│   └── stats.js       # 统计控制器
├── middleware/         # 中间件
│   ├── auth.js        # 认证中间件
│   ├── validation.js  # 验证中间件
│   └── upload.js      # 文件上传中间件
├── routes/            # 路由
├── services/          # 服务层
│   ├── emailService.js
│   ├── imageService.js
│   └── supabaseService.js
├── utils/             # 工具函数
└── config/            # 配置文件
```

### 4.3 API接口设计

#### 4.3.1 认证接口
```javascript
// POST /api/auth/register
{
  "email": "user@51talk.com",
  "name": "张三"
}

// POST /api/auth/verify
{
  "email": "user@51talk.com",
  "code": "123456"
}

// POST /api/auth/login
{
  "email": "user@51talk.com",
  "password": "optional"
}
```

#### 4.3.2 用户信息接口
```javascript
// GET /api/user/profile
// PUT /api/user/profile
{
  "name": "张三",
  "title": "首席成长伙伴",
  "studentsServed": 1000,
  "rating": 4.95,
  "phone": "13800138000"
}

// POST /api/user/avatar
// FormData with image file
```

#### 4.3.3 布局管理接口
```javascript
// GET /api/layout/config
// PUT /api/layout/config (Admin only)
{
  "modules": [
    {
      "id": "avatar",
      "position": { "x": 50, "y": 50, "z": 1 },
      "isLocked": true
    }
  ]
}
```

### 4.4 核心服务实现

#### 4.4.1 图片抠图服务
```javascript
const imageService = {
  async removeBackground(imageFile) {
    const formData = new FormData();
    formData.append('image_file', imageFile);
  
    const response = await axios.post('https://api.remove.bg/v1.0/removebg', formData, {
      headers: {
        'X-Api-Key': process.env.REMOVE_BG_API_KEY,
      },
      responseType: 'arraybuffer'
    });
  
    return response.data;
  }
};
```

#### 4.4.2 邮件验证服务
```javascript
const emailService = {
  async sendVerificationCode(email) {
    const code = Math.random().toString().slice(2, 8);
  
    // 发送邮件逻辑
    await this.sendEmail(email, '验证码', `您的验证码是：${code}`);
  
    // 存储验证码（Redis或内存）
    await this.storeCode(email, code);
  
    return true;
  }
};
```

---

## 5. 数据库设计文档

### 5.1 Supabase配置

#### 5.1.1 环境变量
```env
SUPABASE_URL=your_supabase_url
SUPABASE_ANON_KEY=your_supabase_anon_key
SUPABASE_SERVICE_KEY=your_supabase_service_key
```

#### 5.1.2 表结构详细设计

**用户表扩展**
```sql
-- 添加索引
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);

-- 添加约束
ALTER TABLE users ADD CONSTRAINT check_rating 
CHECK (rating >= 0 AND rating <= 5);

-- 添加触发器更新时间
CREATE OR REPLACE FUNCTION update_updated_at_column()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ language 'plpgsql';

CREATE TRIGGER update_users_updated_at 
BEFORE UPDATE ON users 
FOR EACH ROW EXECUTE FUNCTION update_updated_at_column();
```

**业务能力表**
```sql
CREATE TABLE user_abilities (
  id SERIAL PRIMARY KEY,
  user_id INTEGER REFERENCES users(id) ON DELETE CASCADE,
  ability_type VARCHAR(50) NOT NULL, -- 'teacher_screening', 'feedback', 'planning', 'resource_sharing'
  description TEXT,
  is_enabled BOOLEAN DEFAULT true,
  created_at TIMESTAMP DEFAULT NOW()
);
```

### 5.2 数据访问层
```javascript
const supabaseService = {
  async getUserById(id) {
    const { data, error } = await supabase
      .from('users')
      .select('*')
      .eq('id', id)
      .single();
    
    if (error) throw error;
    return data;
  },

  async updateUserProfile(id, profileData) {
    const { data, error } = await supabase
      .from('users')
      .update(profileData)
      .eq('id', id)
      .select();
    
    if (error) throw error;
    return data[0];
  },

  async logUserAction(userId, actionType, details) {
    const { error } = await supabase
      .from('usage_stats')
      .insert({
        user_id: userId,
        action_type: actionType,
        details: details
      });
    
    if (error) throw error;
  }
};
```

---

## 6. 部署和运维文档

### 6.1 部署架构
```yaml
# docker-compose.yml
version: '3.8'
services:
  frontend:
    build: ./frontend
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://localhost:5000
    
  backend:
    build: ./backend
    ports:
      - "5000:5000"
    environment:
      - NODE_ENV=production
      - SUPABASE_URL=${SUPABASE_URL}
      - REMOVE_BG_API_KEY=${REMOVE_BG_API_KEY}
    depends_on:
      - redis
    
  redis:
    image: redis:alpine
    ports:
      - "6379:6379"
```

### 6.2 环境配置
```env
# 生产环境配置
NODE_ENV=production
PORT=5000

# 数据库配置
SUPABASE_URL=your_production_supabase_url
SUPABASE_ANON_KEY=your_production_anon_key
SUPABASE_SERVICE_KEY=your_production_service_key

# 第三方服务
REMOVE_BG_API_KEY=your_remove_bg_api_key
ALI_EMAIL_API_KEY=your_ali_email_api_key

# JWT配置
JWT_SECRET=your_jwt_secret
JWT_EXPIRE=7d

# Redis配置
REDIS_URL=redis://localhost:6379
```

### 6.3 监控和日志
```javascript
// 日志配置
const winston = require('winston');

const logger = winston.createLogger({
  level: 'info',
  format: winston.format.combine(
    winston.format.timestamp(),
    winston.format.errors({ stack: true }),
    winston.format.json()
  ),
  transports: [
    new winston.transports.File({ filename: 'error.log', level: 'error' }),
    new winston.transports.File({ filename: 'combined.log' })
  ]
});
```

---

## 7. 测试文档

### 7.1 测试策略
- **单元测试：** Jest + React Testing Library
- **集成测试：** Supertest
- **E2E测试：** Cypress
- **API测试：** Postman/Newman

### 7.2 测试用例示例
```javascript
// 用户注册测试
describe('User Registration', () => {
  test('should register user with valid 51talk email', async () => {
    const userData = {
      email: 'test@51talk.com',
      name: '测试用户'
    };
  
    const response = await request(app)
      .post('/api/auth/register')
      .send(userData)
      .expect(200);
    
    expect(response.body.success).toBe(true);
  });

  test('should reject non-51talk email', async () => {
    const userData = {
      email: 'test@gmail.com',
      name: '测试用户'
    };
  
    await request(app)
      .post('/api/auth/register')
      .send(userData)
      .expect(400);
  });
});
```

---

这套完整的文档涵盖了您的名片项目的所有关键方面。每个文档都可以作为独立的指导文件，同时它们之间又相互关联，形成了完整的项目开发指南。您可以根据实际开发进度和需求对这些文档进行调整和完善。